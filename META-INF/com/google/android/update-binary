#!/sbin/sh

#################
# Initialization
#################

umask 022

# echo before loading util_functions

ui_print() { echo "$1"; }

require_new_magisk() {
  ui_print "*******************************"
  ui_print " Please install Magisk v20.4+! "
  ui_print "*******************************"
  exit 1
}

#########################
# Load util_functions.sh
#########################

OUTFD=$2
ZIPFILE=$3

mount /data 2>/dev/null

[ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
. /data/adb/magisk/util_functions.sh
[ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk

if ! $BOOTMODE; then
  ui_print " "
  ui_print " This is a magisk module"
  ui_print " Aborting..."
  ui_print " "
  ui_print " Go and flash in magisk"
  ui_print " "
  exit 0
fi

# Do not remove credits

echo " "
echo "- Module Improved by @DrDisagree"
echo "- Original Template by @Jai_08 // @cool_modules"
echo " "

install_module

remove() {
  rm -rf /data/adb/modules_update/$MODID 2>/dev/null
  rm -rf /data/adb/modules/$MODID 2>/dev/null
}

tar -xf $MODPATH/utils/myutils -C $MODPATH/utils/ 2>/dev/null
zip=$MODPATH/utils/zip
zipalign=$MODPATH/utils/zipalign
bkpath=$MODPATH/original/
mp=$NVBASE/modules

set_perm $zip 0 0 0755
set_perm $zipalign 0 0 0755

ui_print " "
ui_print "- Processing..."
ui_print " "

if apk_path=$(find /system/system_ext/priv-app/ /system/priv-app/ -type d -name "*SystemUI*" -print -quit); then
  spath=$(echo "$apk_path" | sed 's:^/::; s:/$::')
  apkname=$(find "$apk_path" -type f -name "*SystemUI*.apk" -exec basename {} \; | sed 's/\.apk$//')
  ui_print "- Found $apkname.apk"
else
  ui_print "- This looks like a non-supported ROM"
  ui_print "- Report in support group @IconifyDiscussion"
  remove
  exit 1
fi

ui_print " "

insmodules=$(ls $mp)
file=$MODPATH/mod/$apkname.apk

mkdir -p $MODPATH/mod
mkdir -p $bkpath
cp -f $spath/$apkname.apk $bkpath

for i in $insmodules; do
  if [ -f "$mp/$i/original/$apkname.apk" ]; then
    echo "- Existing SystemUI Patcher module detected"
    echo "- Merging the patches..."
    echo " "
    cp -f $mp/$i/original/$apkname.apk $bkpath
    break
  fi
done

cp -f $spath/$apkname.apk $MODPATH/mod/
cd $MODPATH/SystemUI/

if $zip -qq -r $file *; then
  echo "- Installing patches..."
else
  echo "- Failed to patch SystemUI"
  echo "- Try again"
  remove
  exit 1
fi

echo " "
mkdir -p $MODPATH/$spath

if $zipalign -f 4 $file $MODPATH/$spath/$apkname.apk; then
  echo "- Installed successfully"
else
  echo "- Failed to install"
  remove
  exit 1
fi

rm -r $MODPATH/mod/
rm -r $MODPATH/utils/
rm -r $MODPATH/SystemUIMod
sed -i "s|varname|$apkname|g;" $MODPATH/post-fs-data.sh &>/dev/null
sed -i "s|varpath|$spath|g" $MODPATH/post-fs-data.sh &>/dev/null
rm -r /$mp/*/$spath/$apkname.apk

echo " "
echo "- Reboot to apply changes"
echo " "

exit 0
